# Copyright (c) 2026 Veritas Aequitas Holdings LLC. All rights reserved.
"""Known malware campaign detection (ClawHavoc IOCs)."""

from __future__ import annotations

from malwar.core.constants import DetectorLayer, Severity, ThreatCategory
from malwar.detectors.rule_engine.base_rule import BaseRule
from malwar.detectors.rule_engine.registry import rule
from malwar.models.finding import Finding, Location
from malwar.models.skill import SkillContent


@rule
class ClawHavocIndicators(BaseRule):
    rule_id = "MALWAR-MAL-001"
    title = "ClawHavoc campaign indicator"
    severity = Severity.CRITICAL
    category = ThreatCategory.KNOWN_MALWARE
    description = "Detects known ClawHavoc/AMOS infrastructure and operators"

    KNOWN_C2_IPS = ["91.92.242.30"]
    KNOWN_DOMAINS = [
        "glot.io/snippets/hfd3x9ueu5",
        "download.setup-service.com",
        "openclawcli.vercel.app",
    ]
    KNOWN_REPOS = ["Ddoy233/openclawcli"]
    KNOWN_AUTHORS = [
        "zaycv", "clawdhub1", "aslaep123", "pepe276",
        "moonshine-100rze", "ddoy233", "hightower6eu", "hedefbari",
    ]

    def check(self, skill: SkillContent) -> list[Finding]:
        findings = []
        content = skill.raw_content
        content_lower = content.lower()

        for ip in self.KNOWN_C2_IPS:
            if ip in content:
                findings.append(Finding(
                    id=f"{self.rule_id}-ip-{ip}",
                    rule_id=self.rule_id,
                    title="ClawHavoc C2 IP address detected",
                    description=f"Known ClawHavoc C2 IP {ip} found in skill content",
                    severity=Severity.CRITICAL,
                    confidence=0.99,
                    category=self.category,
                    detector_layer=DetectorLayer.RULE_ENGINE,
                    location=Location(
                        line_start=self._find_line(content, ip),
                        snippet=ip,
                    ),
                    ioc_values=[ip],
                    evidence=[f"Known ClawHavoc C2: {ip}"],
                ))

        for domain in self.KNOWN_DOMAINS:
            if domain.lower() in content_lower:
                findings.append(Finding(
                    id=f"{self.rule_id}-dom-{domain[:20]}",
                    rule_id=self.rule_id,
                    title="ClawHavoc payload domain detected",
                    description=f"Known ClawHavoc domain {domain} found",
                    severity=Severity.CRITICAL,
                    confidence=0.98,
                    category=self.category,
                    detector_layer=DetectorLayer.RULE_ENGINE,
                    location=Location(
                        line_start=self._find_line(content_lower, domain.lower()),
                        snippet=domain,
                    ),
                    ioc_values=[domain],
                    evidence=[f"Known ClawHavoc domain: {domain}"],
                ))

        for repo in self.KNOWN_REPOS:
            if repo.lower() in content_lower:
                findings.append(Finding(
                    id=f"{self.rule_id}-repo-{repo[:20]}",
                    rule_id=self.rule_id,
                    title="ClawHavoc GitHub repository detected",
                    description=f"Known ClawHavoc repo {repo} found",
                    severity=Severity.CRITICAL,
                    confidence=0.97,
                    category=self.category,
                    detector_layer=DetectorLayer.RULE_ENGINE,
                    location=Location(
                        line_start=self._find_line(content_lower, repo.lower()),
                        snippet=repo,
                    ),
                    ioc_values=[repo],
                    evidence=[f"Known ClawHavoc repo: {repo}"],
                ))

        author = (skill.metadata.author or "").lower()
        if author in self.KNOWN_AUTHORS:
            findings.append(Finding(
                id=f"{self.rule_id}-author-{author}",
                rule_id=self.rule_id,
                title="Known malicious author",
                description=f"Skill author '{author}' is a known ClawHavoc operator",
                severity=Severity.CRITICAL,
                confidence=0.95,
                category=self.category,
                detector_layer=DetectorLayer.RULE_ENGINE,
                location=Location(line_start=1, snippet=f"author: {author}"),
                evidence=[f"Known threat actor: {author}"],
            ))

        return findings

    @staticmethod
    def _find_line(content: str, needle: str) -> int:
        idx = content.find(needle)
        if idx == -1:
            return 1
        return content[:idx].count("\n") + 1
